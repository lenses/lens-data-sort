<link rel="import" href="../polymer/polymer.html"> 
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../lens-u-data-utility/lens-u-data-utility.html">

<!--
A Thelma component for sorting data by a column's values. Can sort both text and numbers in ascending or descending order.

##### Example

    <lens-data-sort></lens-data-sort>

@element lens-data-sort
@blurb Sort data by the values of a column.
@status alpha
@homepage http://lenses.github.io/lens-data-sort
-->

<dom-module id="lens-data-sort">
  <link rel="import" type="css" href="lens-data-sort.css">
  <template>

    <lens-u-data-utility id="data_utility"></lens-u-data-utility>

    <div class="lens-container lens-data">
        <p class="info">Sort rows.</p>
        <label for="func_selector">Sort by column:</label>
        <iron-selector id="value_selector" selected="{{sortColumn}}" attr-for-selected="label">
          <template is="dom-repeat" items="{{_dataAttributes}}" as="attr">
            <div class="col" label="{{attr}}">{{attr}}</div>
          </template>
        </iron-selector>
        <label for="sort_selector">Sort order:</label>
        <iron-selector id="func_selector" selected="{{sortType}}" attr-for-selected="label">
            <div class="col" label="asc">Ascending</div>
            <div class="col" label="desc">Descending</div>
        </iron-selector>
    </div>

  </template>
</dom-module>
<script>
  Polymer({
    is: 'lens-data-sort',
    properties: {
      input: {
        notify: true,
        observer: 'inputChanged'
      },
      output: { notify: true },
      sortColumn: {
        notify: true,
        observer: 'sortColumnChanged'
      },
      sortType: {
        type: String,
        value: 'asc',
        notify: true,
        observer: 'sortTypeChanged'
      }
    },
    /**
     *  sortColumn is the name of the column that will be used to sort the array of data.
     *
     *  @property sortColumn
     *  @type String
     */
    ready: function () {
      //open the collapse if it the component is included
      if (this.included && !this.$.ctrl_collapse.opened) {
        this.$.ctrl_collapse.toggle();
      }
    },
    inputChanged: function () {
      var self = this;
      var firstItem = self.input[0];
      if (!firstItem) {
        return;
      }
      var attributes = Object.keys(firstItem);
      if (JSON.stringify(self._dataAttributes) === JSON.stringify(attributes)) {
      }  //self._mapChartData();
      else
        //self._mapChartData();
        {
          self._dataAttributes = attributes;
        }
      self._calculateOutput();
    },
    _calculateOutput: function () {
      var self = this;
      if (self.sortColumn) {
        self.output = _.sortBy(self.input, function (item) {
          var value = item[self.sortColumn];
          var isDate = self.$.data_utility.parseDate(value);
          if (isDate) {
            return isDate;
          }
          var numeric = self.$.data_utility.unformatStringIfNumeric(value);
          return numeric;
        });
        if (self.sortType === 'desc') {
          self.output.reverse();
        }
      }
    },
    sortColumnChanged: function (_, e) {
      var self = this;
      self._calculateOutput();
    },
    sortTypeChanged: function (_, e) {
      var self = this;
      self._calculateOutput();
    }
  });
</script><script src="../lodash/lodash.js"></script>